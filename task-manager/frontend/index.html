<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Manager Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white flex flex-col items-center justify-center p-6">

  <!-- Header -->
  <h1 class="text-4xl font-bold mb-8 animate__animated animate__fadeInDown text-center">
    🚀 Task Manager <span class="text-teal-400">Pro</span>
  </h1>

  <!-- Connection Status -->
  <div id="connectionStatus" class="mb-4 px-4 py-2 rounded-lg text-sm font-medium">
    🔄 Connecting to server...
  </div>

  <div class="grid md:grid-cols-2 gap-8 w-full max-w-6xl">
    
    <!-- User Section -->
    <div class="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 animate__animated animate__fadeInLeft">
      <h2 class="text-2xl font-semibold mb-4 text-teal-300">👤 Users</h2>
      
      <!-- Add User Form -->
      <form id="userForm" class="mb-4 space-y-3">
        <input type="text" id="userName" placeholder="Name" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-400" required>
        <input type="email" id="userEmail" placeholder="Email" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-400" required>
        <button type="submit" class="w-full py-2 bg-teal-500 hover:bg-teal-400 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed" id="addUserBtn">
          Add User
        </button>
      </form>

      <!-- User List -->
      <ul id="userList" class="space-y-2"></ul>
    </div>

    <!-- Task Section -->
    <div class="bg-white/10 backdrop-blur-lg rounded-2xl shadow-lg p-6 animate__animated animate__fadeInRight">
      <h2 class="text-2xl font-semibold mb-4 text-yellow-300">✅ Tasks</h2>
      
      <!-- Add Task Form -->
      <form id="taskForm" class="mb-4 space-y-3">
        <input type="text" id="taskTitle" placeholder="Task Title" class="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-yellow-400" required>
        
        <!-- User Selection Dropdown -->
        <select id="taskUserId" class="w-full px-3 py-2 rounded-lg bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400" required>
          <option value="" class="bg-gray-800 text-gray-300">Select User</option>
        </select>
        
        <!-- Status Selection Dropdown -->
        <select id="taskStatus" class="w-full px-3 py-2 rounded-lg bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-yellow-400">
          <option value="pending" class="bg-gray-800 text-white">📋 Pending</option>
          <option value="in-progress" class="bg-gray-800 text-white">⚡ In Progress</option>
          <option value="done" class="bg-gray-800 text-white">✅ Done</option>
        </select>
        
        <button type="submit" class="w-full py-2 bg-yellow-500 hover:bg-yellow-400 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed" id="addTaskBtn">
          Add Task
        </button>
      </form>

      <!-- Task List -->
      <ul id="taskList" class="space-y-2"></ul>
    </div>
  </div>

  <script>
    const API = "http://localhost:4000";
    let isConnected = false;

    // Status icons and colors
    const statusConfig = {
      pending: { icon: "📋", color: "text-gray-400", bg: "bg-gray-500/20" },
      "in-progress": { icon: "⚡", color: "text-blue-400", bg: "bg-blue-500/20" },
      done: { icon: "✅", color: "text-green-400", bg: "bg-green-500/20" }
    };

    // Connection status indicator
    function updateConnectionStatus(connected) {
      const status = document.getElementById("connectionStatus");
      isConnected = connected;
      
      if (connected) {
        status.textContent = "✅ Connected to server";
        status.className = "mb-4 px-4 py-2 rounded-lg text-sm font-medium bg-green-500/20 text-green-400";
      } else {
        status.textContent = "❌ Server connection failed";
        status.className = "mb-4 px-4 py-2 rounded-lg text-sm font-medium bg-red-500/20 text-red-400";
      }
      
      // Enable/disable buttons based on connection
      const buttons = document.querySelectorAll('#addUserBtn, #addTaskBtn');
      buttons.forEach(btn => btn.disabled = !connected);
    }

    // API helper function with error handling
    async function apiCall(url, options = {}) {
      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          }
        });
        
        if (!response.ok) {
          // Don't mark as disconnected for HTTP errors (like 404, 500)
          const errorMsg = `HTTP ${response.status}: ${response.statusText}`;
          console.error('API call failed:', errorMsg);
          showMessage(errorMsg, "error");
          throw new Error(errorMsg);
        }
        
        // If we get here, connection is working
        if (!isConnected) {
          updateConnectionStatus(true);
        }
        
        return await response.json();
      } catch (error) {
        console.error('API call failed:', error);
        
        // Only mark as disconnected for network errors (not HTTP errors)
        if (error.name === 'TypeError' || error.message.includes('fetch')) {
          updateConnectionStatus(false);
          showMessage(`Connection Error: ${error.message}`, "error");
        } else {
          showMessage(`API Error: ${error.message}`, "error");
        }
        throw error;
      }
    }

    async function loadUsers() {
      try {
        const users = await apiCall(`${API}/users`);
        const list = document.getElementById("userList");
        const userSelect = document.getElementById("taskUserId");
        
        updateConnectionStatus(true);
        
        // Update user list
        list.innerHTML = "";
        users.forEach(u => {
          const li = document.createElement("li");
          li.className = "flex justify-between items-center bg-white/20 px-4 py-2 rounded-lg hover:bg-white/30 transition";
          li.innerHTML = `
            <span><strong>ID:${u.id}</strong> ${u.name} <span class="text-gray-400">(${u.email})</span></span>
            <button class="text-red-400 hover:text-red-300 font-bold px-2 py-1 rounded transition" onclick="deleteUser(${u.id})">🗑</button>
          `;
          list.appendChild(li);
        });

        // Update user dropdown in task form
        const currentValue = userSelect.value;
        userSelect.innerHTML = '<option value="" class="bg-gray-800 text-gray-300">Select User</option>';
        users.forEach(u => {
          const option = document.createElement("option");
          option.value = u.id;
          option.textContent = `${u.name} (ID: ${u.id})`;
          option.className = "bg-gray-800 text-white";
          if (u.id == currentValue) option.selected = true;
          userSelect.appendChild(option);
        });
      } catch (error) {
        document.getElementById("userList").innerHTML = '<li class="text-red-400 text-center py-4">Failed to load users</li>';
      }
    }

    async function loadTasks() {
      try {
        const tasks = await apiCall(`${API}/tasks`);
        const list = document.getElementById("taskList");
        
        list.innerHTML = "";
        
        tasks.forEach(t => {
          const status = statusConfig[t.status] || statusConfig.pending;
          const userName = t.user ? t.user.name : 'Unassigned';
          
          const li = document.createElement("li");
          li.className = `flex justify-between items-center bg-white/20 px-4 py-2 rounded-lg hover:bg-white/30 transition border-l-4 ${status.bg}`;
          li.innerHTML = `
            <div class="flex-1">
              <div class="font-semibold">${t.title}</div>
              <div class="text-sm text-gray-400">
                ${status.icon} <span class="${status.color}">${t.status.replace('-', ' ').toUpperCase()}</span>
                • Assigned to: ${userName}
              </div>
            </div>
            <div class="flex space-x-2">
              <button class="text-blue-400 hover:text-blue-300 font-bold px-2 py-1 rounded transition" onclick="toggleTaskStatus(${t.id}, '${t.status}')" title="Change Status">🔄</button>
              <button class="text-red-400 hover:text-red-300 font-bold px-2 py-1 rounded transition" onclick="deleteTask(${t.id})" title="Delete Task">🗑</button>
            </div>
          `;
          list.appendChild(li);
        });
      } catch (error) {
        document.getElementById("taskList").innerHTML = '<li class="text-red-400 text-center py-4">Failed to load tasks</li>';
      }
    }

    // Add User
    document.getElementById("userForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const name = document.getElementById("userName").value.trim();
      const email = document.getElementById("userEmail").value.trim();
      
      try {
        await apiCall(`${API}/users`, {
          method: "POST",
          body: JSON.stringify({ name, email })
        });
        
        document.getElementById("userForm").reset();
        await loadUsers();
        showMessage("User added successfully!", "success");
      } catch (error) {
        console.error('Add user failed:', error);
        // Try to reload users in case it actually worked
        try {
          await loadUsers();
        } catch (reloadError) {
          console.error('Failed to reload users after add attempt:', reloadError);
        }
      }
    });

    // Add Task
    document.getElementById("taskForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const title = document.getElementById("taskTitle").value.trim();
      const userId = parseInt(document.getElementById("taskUserId").value);
      const status = document.getElementById("taskStatus").value;
      
      try {
        await apiCall(`${API}/tasks`, {
          method: "POST",
          body: JSON.stringify({ title, status, userId })
        });
        
        document.getElementById("taskForm").reset();
        document.getElementById("taskStatus").value = "pending";
        await loadTasks();
        showMessage("Task added successfully!", "success");
      } catch (error) {
        console.error('Add task failed:', error);
        // Try to reload tasks in case it actually worked
        try {
          await loadTasks();
        } catch (reloadError) {
          console.error('Failed to reload tasks after add attempt:', reloadError);
        }
      }
    });

    // Delete User
    async function deleteUser(id) {
      if (!confirm("Delete this user? This will also remove all tasks assigned to them.")) return;
      
      console.log('Attempting to delete user ID:', id);
      console.log('Delete URL:', `${API}/users/${id}`);
      
      try {
        const result = await apiCall(`${API}/users/${id}`, { method: "DELETE" });
        console.log('Delete result:', result);
        await Promise.all([loadUsers(), loadTasks()]);
        showMessage("User deleted successfully!", "success");
      } catch (error) {
        console.error('Delete user failed:', error);
        
        // Check if it's a 404 error - maybe the user was already deleted
        if (error.message.includes('404')) {
          showMessage("User might already be deleted. Refreshing data...", "info");
          try {
            await Promise.all([loadUsers(), loadTasks()]);
          } catch (reloadError) {
            console.error('Failed to reload data after 404:', reloadError);
          }
        } else {
          // For other errors, still try to reload
          try {
            await Promise.all([loadUsers(), loadTasks()]);
          } catch (reloadError) {
            console.error('Failed to reload data after delete attempt:', reloadError);
          }
        }
      }
    }

    // Delete Task
    async function deleteTask(id) {
      if (!confirm("Delete this task?")) return;
      
      try {
        await apiCall(`${API}/tasks/${id}`, { method: "DELETE" });
        await loadTasks();
        showMessage("Task deleted successfully!", "success");
      } catch (error) {
        console.error('Delete task failed:', error);
        // Try to reload data anyway in case the delete actually worked
        try {
          await loadTasks();
        } catch (reloadError) {
          console.error('Failed to reload tasks after delete attempt:', reloadError);
        }
      }
    }

    // Toggle Task Status
    async function toggleTaskStatus(id, currentStatus) {
      const statusOrder = ["pending", "in-progress", "done"];
      const currentIndex = statusOrder.indexOf(currentStatus);
      const nextIndex = (currentIndex + 1) % statusOrder.length;
      const newStatus = statusOrder[nextIndex];
      
      try {
        await apiCall(`${API}/tasks/${id}`, {
          method: "PUT",
          body: JSON.stringify({ status: newStatus })
        });
        
        await loadTasks();
        showMessage(`Task status changed to ${newStatus.replace('-', ' ')}!`, "info");
      } catch (error) {
        console.error('Toggle task status failed:', error);
        // Try to reload data anyway in case the update actually worked
        try {
          await loadTasks();
        } catch (reloadError) {
          console.error('Failed to reload tasks after status toggle attempt:', reloadError);
        }
      }
    }

    // Show temporary message
    function showMessage(text, type = "info") {
      const colors = {
        success: "bg-green-500",
        error: "bg-red-500",
        info: "bg-blue-500"
      };
      
      const msg = document.createElement("div");
      msg.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate__animated animate__fadeInRight`;
      msg.textContent = text;
      
      document.body.appendChild(msg);
      
      setTimeout(() => {
        msg.classList.remove("animate__fadeInRight");
        msg.classList.add("animate__fadeOutRight");
        setTimeout(() => msg.remove(), 500);
      }, 3000);
    }

    // Initialize app
    async function init() {
      updateConnectionStatus(false);
      
      try {
        // Test server connection first
        console.log('Testing server connection...');
        const testResponse = await fetch(`${API}/users`);
        console.log('Server test response:', testResponse.status);
        
        await Promise.all([loadUsers(), loadTasks()]);
        console.log("🎉 App initialized successfully!");
      } catch (error) {
        console.error("Failed to initialize app:", error);
        showMessage("Please make sure the server is running on http://localhost:4000", "error");
        
        // Show debug info
        console.log('Debug info:');
        console.log('- API URL:', API);
        console.log('- Error type:', error.name);
        console.log('- Error message:', error.message);
      }
    }

    // Start the app
    init();
  </script>
</body>
</html>